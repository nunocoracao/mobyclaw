# ─────────────────────────────────────────────────────────────
# mobyclaw — Docker Compose stack
#
# Services:
#   moby          — AI agent (cagent serve api)
#   gateway       — Message routing (Telegram, etc.)
#   tool-gateway  — MCP tool aggregator (browser, weather, etc.)
#   dashboard     — Web dashboard + Task API + Tunnel
#
# Usage:
#   mobyclaw up    — start everything
#   mobyclaw down  — stop everything
#   mobyclaw logs  — view logs
# ─────────────────────────────────────────────────────────────

services:
  moby:
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - ${MOBYCLAW_HOME:-~/.mobyclaw}:/home/agent/.mobyclaw
      - ${MOBYCLAW_HOME:-~/.mobyclaw}/gh:/home/agent/.config/gh
      - .:/source
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}

    restart: unless-stopped
    networks:
      - mobyclaw
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: "1.0"

  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ${MOBYCLAW_HOME:-~/.mobyclaw}:/data/.mobyclaw
    environment:
      - AGENT_URL=http://moby:8080
      - MOBYCLAW_HOME=/data/.mobyclaw
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_ALLOWED_USERS=${TELEGRAM_ALLOWED_USERS:-}
      - DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN:-}
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - WHATSAPP_AUTH=${WHATSAPP_AUTH:-}
      - MOBYCLAW_HEARTBEAT_INTERVAL=${MOBYCLAW_HEARTBEAT_INTERVAL:-2h}
      - MOBYCLAW_ACTIVE_HOURS=${MOBYCLAW_ACTIVE_HOURS:-07:00-23:00}
      - EXPLORATION_ENABLED=${EXPLORATION_ENABLED:-true}
      - EXPLORATION_FREQUENCY=${EXPLORATION_FREQUENCY:-4}
      - EXPLORATION_MAX_FETCHES=${EXPLORATION_MAX_FETCHES:-1}
      - EXPLORATION_SUMMARY_WORDS=${EXPLORATION_SUMMARY_WORDS:-300}
      - TZ=${TZ:-UTC}
    depends_on:
      - moby
    restart: unless-stopped
    networks:
      - mobyclaw

  tool-gateway:
    build:
      context: ./tool-gateway
      dockerfile: Dockerfile
    expose:
      - "8081"
    ports:
      - "3100:3100"
    volumes:
      - ${MOBYCLAW_HOME:-~/.mobyclaw}:/data/.mobyclaw
    environment:
      - MCP_PORT=8081
      - ADMIN_PORT=3100
      - AUTH_STORE_PATH=/data/.mobyclaw/tool-auth
    restart: unless-stopped
    networks:
      - mobyclaw

  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    ports:
      - "7777:7777"
    volumes:
      - ${MOBYCLAW_HOME:-~/.mobyclaw}:/data/.mobyclaw
    environment:
      - MOBYCLAW_DATA=/data/.mobyclaw
      - DASHBOARD_PORT=7777
      - GATEWAY_URL=http://gateway:3000
      - ENABLE_TUNNEL=${ENABLE_TUNNEL:-false}
    depends_on:
      - gateway
    restart: unless-stopped
    networks:
      - mobyclaw
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: "0.25"

networks:
  mobyclaw:
    driver: bridge
