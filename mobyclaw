#!/usr/bin/env bash
set -euo pipefail

# ─────────────────────────────────────────────────────────────
# mobyclaw — CLI for your personal AI agent
# ─────────────────────────────────────────────────────────────

VERSION="0.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
MOBYCLAW_HOME="${MOBYCLAW_HOME:-$HOME/.mobyclaw}"
COMPOSE_FILE="$SCRIPT_DIR/docker-compose.yml"
OVERRIDE_FILE="$SCRIPT_DIR/docker-compose.override.yml"
ENV_FILE="$SCRIPT_DIR/.env"

CREDENTIALS_FILE="$MOBYCLAW_HOME/credentials.env"
WORKSPACES_FILE="$MOBYCLAW_HOME/workspaces.conf"
RESTART_SIGNAL="$MOBYCLAW_HOME/.restart"
WATCHER_PID_FILE="$MOBYCLAW_HOME/.watcher.pid"

# ─── Colors & formatting ─────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m' # No Color

# ─── Helpers ──────────────────────────────────────────────────

info()    { echo -e "${BLUE}ℹ${NC} $*"; }
success() { echo -e "${GREEN}✓${NC} $*"; }
warn()    { echo -e "${YELLOW}⚠${NC} $*"; }
error()   { echo -e "${RED}✗${NC} $*" >&2; }
step()    { echo -e "\n${BOLD}${MAGENTA}▸ $*${NC}"; }
dim()     { echo -e "${DIM}$*${NC}"; }

banner() {
    echo -e "${CYAN}${BOLD}"
    cat << 'EOF'
                 _                _
  _ __ ___   ___| |__  _   _  ___| | __ ___      __
 | '_ ` _ \ / _ \ '_ \| | | |/ __| |/ _` \ \ /\ / /
 | | | | | | (_) | |_) | |_| | (__| | (_| |\ V  V /
 |_| |_| |_|\___/|_.__/ \__, |\___|_|\__,_| \_/\_/
                         |___/
EOF
    echo -e "${NC}"
    dim "  Your personal AI agent, containerized."
    echo ""
}

ask() {
    local prompt="$1"
    local default="${2:-}"
    if [[ -n "$default" ]]; then
        echo -en "  ${prompt} ${DIM}[${default}]${NC}: "
    else
        echo -en "  ${prompt}: "
    fi
    read -r REPLY
    REPLY="${REPLY:-$default}"
}

confirm() {
    local prompt="$1"
    local default="${2:-y}"
    local hint
    if [[ "$default" == "y" ]]; then hint="Y/n"; else hint="y/N"; fi
    echo -en "  ${prompt} ${DIM}[${hint}]${NC}: "
    read -r REPLY
    REPLY="${REPLY:-$default}"
    [[ "$REPLY" =~ ^[Yy] ]]
}

ask_secret() {
    local prompt="$1"
    echo -en "  ${prompt}: "
    read -rs REPLY
    echo ""
}

# Run docker compose with the right files (includes override when present)
dc() {
    local args=(-f "$COMPOSE_FILE")
    if [[ -f "$OVERRIDE_FILE" ]]; then
        args+=(-f "$OVERRIDE_FILE")
    fi
    args+=(--env-file "$ENV_FILE")
    docker compose "${args[@]}" "$@"
}

# Resolve a path: expand ~ and make absolute
resolve_path() {
    local p="$1"
    # Expand ~ at the start
    p="${p/#\~/$HOME}"
    # Make absolute
    if [[ "$p" != /* ]]; then
        p="$(cd "$(dirname "$p")" 2>/dev/null && pwd)/$(basename "$p")"
    fi
    echo "$p"
}

# Read MOBYCLAW_HOME from .env if it exists (used by cmd_up, etc.)
load_env_home() {
    if [[ -f "$ENV_FILE" ]]; then
        local env_home
        env_home=$(grep -E '^MOBYCLAW_HOME=' "$ENV_FILE" 2>/dev/null | cut -d= -f2- || true)
        if [[ -n "$env_home" ]]; then
            MOBYCLAW_HOME="$env_home"
            CREDENTIALS_FILE="$MOBYCLAW_HOME/credentials.env"
            WORKSPACES_FILE="$MOBYCLAW_HOME/workspaces.conf"
            RESTART_SIGNAL="$MOBYCLAW_HOME/.restart"
            WATCHER_PID_FILE="$MOBYCLAW_HOME/.watcher.pid"
        fi
    fi
}

# ─── Restart watcher ────────────────────────────────────

# The restart watcher polls ~/.mobyclaw/.restart every 5 seconds.
# When the agent writes to this file, the watcher performs the
# requested action so changes take effect.
#
# Signal file contents:
#   "restart"          — docker compose restart moby (~5s)
#   "rebuild"          — docker compose up -d --build moby (~30s)
#   "rebuild-gateway"  — docker compose up -d --build gateway (~20s)
#   "rebuild-all"      — docker compose up -d --build (~45s)
#   anything else      — treated as "restart"

restart_watcher() {
    while true; do
        sleep 5
        if [[ -f "$RESTART_SIGNAL" ]]; then
            local action
            action=$(cat "$RESTART_SIGNAL" 2>/dev/null | head -1 | tr -d '[:space:]')
            rm -f "$RESTART_SIGNAL"

            local timestamp
            timestamp=$(date '+%Y-%m-%d %H:%M:%S')

            case "$action" in
                rebuild)
                    echo "[$timestamp] Rebuild moby requested by agent" >> "$MOBYCLAW_HOME/logs/watcher.log"
                    dc up -d --build moby >> "$MOBYCLAW_HOME/logs/watcher.log" 2>&1
                    echo "[$timestamp] Rebuild moby complete" >> "$MOBYCLAW_HOME/logs/watcher.log"
                    ;;
                rebuild-gateway)
                    echo "[$timestamp] Rebuild gateway requested by agent" >> "$MOBYCLAW_HOME/logs/watcher.log"
                    dc up -d --build gateway >> "$MOBYCLAW_HOME/logs/watcher.log" 2>&1
                    echo "[$timestamp] Rebuild gateway complete" >> "$MOBYCLAW_HOME/logs/watcher.log"
                    ;;
                rebuild-all)
                    echo "[$timestamp] Rebuild all requested by agent" >> "$MOBYCLAW_HOME/logs/watcher.log"
                    dc up -d --build >> "$MOBYCLAW_HOME/logs/watcher.log" 2>&1
                    echo "[$timestamp] Rebuild all complete" >> "$MOBYCLAW_HOME/logs/watcher.log"
                    ;;
                *)
                    echo "[$timestamp] Restart requested by agent" >> "$MOBYCLAW_HOME/logs/watcher.log"
                    dc restart moby >> "$MOBYCLAW_HOME/logs/watcher.log" 2>&1
                    echo "[$timestamp] Restart complete" >> "$MOBYCLAW_HOME/logs/watcher.log"
                    ;;
            esac
        fi
    done
}

start_watcher() {
    # Kill any existing watcher
    stop_watcher 2>/dev/null || true

    # Ensure log directory exists
    mkdir -p "$MOBYCLAW_HOME/logs"

    # Clean up stale signal file
    rm -f "$RESTART_SIGNAL"

    # Start watcher as a fully detached background process.
    # We launch it via nohup in a subshell so it survives the
    # parent shell exiting. stdin/stdout/stderr are redirected
    # to prevent any terminal attachment.
    (
        nohup bash -c '
            COMPOSE_FILE="'"$COMPOSE_FILE"'"
            OVERRIDE_FILE="'"$OVERRIDE_FILE"'"
            ENV_FILE="'"$ENV_FILE"'"
            RESTART_SIGNAL="'"$RESTART_SIGNAL"'"
            MOBYCLAW_HOME="'"$MOBYCLAW_HOME"'"

            dc() {
                local args=(-f "$COMPOSE_FILE")
                if [[ -f "$OVERRIDE_FILE" ]]; then
                    args+=(-f "$OVERRIDE_FILE")
                fi
                args+=(--env-file "$ENV_FILE")
                docker compose "${args[@]}" "$@"
            }

            while true; do
                sleep 5
                if [[ -f "$RESTART_SIGNAL" ]]; then
                    action=$(head -1 "$RESTART_SIGNAL" 2>/dev/null | tr -d "[:space:]")
                    rm -f "$RESTART_SIGNAL"
                    ts=$(date "+%Y-%m-%d %H:%M:%S")
                    case "$action" in
                        rebuild)
                            echo "[$ts] Rebuild moby requested by agent" >> "$MOBYCLAW_HOME/logs/watcher.log"
                            dc up -d --build moby >> "$MOBYCLAW_HOME/logs/watcher.log" 2>&1
                            echo "[$ts] Rebuild moby complete" >> "$MOBYCLAW_HOME/logs/watcher.log"
                            ;;
                        rebuild-gateway)
                            echo "[$ts] Rebuild gateway requested by agent" >> "$MOBYCLAW_HOME/logs/watcher.log"
                            dc up -d --build gateway >> "$MOBYCLAW_HOME/logs/watcher.log" 2>&1
                            echo "[$ts] Rebuild gateway complete" >> "$MOBYCLAW_HOME/logs/watcher.log"
                            ;;
                        rebuild-all)
                            echo "[$ts] Rebuild all requested by agent" >> "$MOBYCLAW_HOME/logs/watcher.log"
                            dc up -d --build >> "$MOBYCLAW_HOME/logs/watcher.log" 2>&1
                            echo "[$ts] Rebuild all complete" >> "$MOBYCLAW_HOME/logs/watcher.log"
                            ;;
                        *)
                            echo "[$ts] Restart requested by agent" >> "$MOBYCLAW_HOME/logs/watcher.log"
                            dc restart moby >> "$MOBYCLAW_HOME/logs/watcher.log" 2>&1
                            echo "[$ts] Restart complete" >> "$MOBYCLAW_HOME/logs/watcher.log"
                            ;;
                    esac
                fi
            done
        ' </dev/null >/dev/null 2>&1 &
        echo $! > "$WATCHER_PID_FILE"
    )
}

stop_watcher() {
    if [[ -f "$WATCHER_PID_FILE" ]]; then
        local pid
        pid=$(cat "$WATCHER_PID_FILE" 2>/dev/null)
        if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
            kill "$pid" 2>/dev/null || true
        fi
        rm -f "$WATCHER_PID_FILE"
    fi
}

is_watcher_running() {
    if [[ -f "$WATCHER_PID_FILE" ]]; then
        local pid
        pid=$(cat "$WATCHER_PID_FILE" 2>/dev/null)
        [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null
    else
        return 1
    fi
}

# ─── Override generation ──────────────────────────────────────

# Generate docker-compose.override.yml from credentials.env and
# workspaces.conf. Called before every `docker compose up`.
generate_override() {
    local has_creds=false
    local has_workspaces=false

    # Check if credentials.env has any actual key=value lines
    if [[ -f "$CREDENTIALS_FILE" ]]; then
        if grep -qE '^[A-Za-z_][A-Za-z0-9_]*=' "$CREDENTIALS_FILE" 2>/dev/null; then
            has_creds=true
        fi
    fi

    # Check if workspaces.conf has any entries
    if [[ -f "$WORKSPACES_FILE" ]]; then
        if grep -qE '^[A-Za-z0-9_-]+=' "$WORKSPACES_FILE" 2>/dev/null; then
            has_workspaces=true
        fi
    fi

    # If nothing to add, remove the override file
    if [[ "$has_creds" == false && "$has_workspaces" == false ]]; then
        rm -f "$OVERRIDE_FILE"
        return 0
    fi

    # Build the override YAML
    local abs_creds
    abs_creds=$(resolve_path "$CREDENTIALS_FILE")

    cat > "$OVERRIDE_FILE" << 'HEADER'
# AUTO-GENERATED by mobyclaw — do not edit manually
# Source: ~/.mobyclaw/credentials.env + ~/.mobyclaw/workspaces.conf
# Regenerated on every `mobyclaw up`

services:
  moby:
HEADER

    # Add env_file for credentials
    if [[ "$has_creds" == true ]]; then
        cat >> "$OVERRIDE_FILE" << EOF
    env_file:
      - ${abs_creds}
EOF
    fi

    # Add volume mounts for workspaces
    if [[ "$has_workspaces" == true ]]; then
        echo "    volumes:" >> "$OVERRIDE_FILE"
        while IFS='=' read -r name path; do
            # Skip comments and empty lines
            [[ -z "$name" || "$name" == \#* ]] && continue
            # Trim whitespace
            name=$(echo "$name" | xargs)
            path=$(echo "$path" | xargs)
            [[ -z "$name" || -z "$path" ]] && continue
            echo "      - ${path}:/workspace/${name}" >> "$OVERRIDE_FILE"
        done < "$WORKSPACES_FILE"
    fi
}

# ─── Streaming helper ────────────────────────────────────────

stream_prompt() {
    local message="$1"
    local session_id="${2:-api:direct}"

    local tool_label_file
    tool_label_file=$(mktemp)
    trap "rm -f '$tool_label_file'" RETURN

    local had_tools=false
    local in_response=false

    curl -sN --max-time 300 \
        -X POST http://localhost:3000/prompt/stream \
        -H "Content-Type: application/json" \
        -d "$(jq -n --arg m "$message" --arg s "$session_id" '{message: $m, session_id: $s}')" \
        2>/dev/null | while IFS= read -r line; do

        if [[ "$line" == event:\ token ]]; then
            IFS= read -r dataline
            if [[ "$dataline" == data:\ * ]]; then
                if [[ "$had_tools" == true && "$in_response" == false ]]; then
                    echo ""
                    in_response=true
                fi
                in_response=true
                echo -n "$dataline" | sed 's/^data: //' | jq -rj '.text // empty' 2>/dev/null
            fi

        elif [[ "$line" == event:\ tool ]]; then
            IFS= read -r dataline
            if [[ "$dataline" == data:\ * ]]; then
                local payload status detail success_val
                payload=$(echo -n "$dataline" | sed 's/^data: //')
                status=$(echo "$payload" | jq -r '.status // empty' 2>/dev/null)
                detail=$(echo "$payload" | jq -r '.detail // empty' 2>/dev/null)
                success_val=$(echo "$payload" | jq -r 'if .success == false then "false" else "true" end' 2>/dev/null)

                if [[ "$status" == "start" ]]; then
                    had_tools=true
                    echo "$detail" > "$tool_label_file"
                    echo -e "${DIM}  ⏳ ${detail}...${NC}"

                elif [[ "$status" == "detail" ]]; then
                    echo "$detail" > "$tool_label_file"
                    echo -en "\033[1A\r\033[K"
                    echo -e "${DIM}  ⏳ ${detail}...${NC}"

                elif [[ "$status" == "done" ]]; then
                    local label
                    label=$(cat "$tool_label_file" 2>/dev/null)
                    local icon="${GREEN}✅${NC}"
                    if [[ "$success_val" == "false" ]]; then
                        icon="${RED}❌${NC}"
                    fi
                    echo -en "\033[1A\r\033[K"
                    echo -e "  ${icon} ${DIM}${label}${NC}"
                fi
            fi

        elif [[ "$line" == event:\ error ]]; then
            IFS= read -r dataline
            if [[ "$dataline" == data:\ * ]]; then
                local errmsg
                errmsg=$(echo -n "$dataline" | sed 's/^data: //' | jq -r '.message // empty' 2>/dev/null)
                echo -e "\n${RED}Error: ${errmsg}${NC}" >&2
            fi

        elif [[ "$line" == event:\ done ]]; then
            break
        fi
    done

    echo "" # final newline
}

# ─── Commands ─────────────────────────────────────────────────

cmd_init() {
    local called_from_up="${1:-false}"

    banner

    step "Checking prerequisites"

    local missing=0
    for tool in docker curl jq; do
        if command -v "$tool" &>/dev/null; then
            success "$tool found"
        else
            error "$tool not found — please install it first"
            missing=1
        fi
    done

    if ! docker info &>/dev/null 2>&1; then
        error "Docker daemon is not running"
        missing=1
    else
        success "Docker daemon is running"
    fi

    if [[ "$missing" -eq 1 ]]; then
        echo ""
        error "Missing prerequisites. Please install them and try again."
        exit 1
    fi

    if [[ -f "$ENV_FILE" ]]; then
        echo ""
        warn "Found existing .env file at $ENV_FILE"
        if ! confirm "Overwrite and reconfigure?" "n"; then
            info "Keeping existing config."
            return 0
        fi
    fi

    # ── LLM Provider ──────────────────────────────────────────
    step "LLM Provider"
    echo ""
    info "Moby needs an LLM to think. Pick your provider."
    echo ""
    echo -e "  ${BOLD}1)${NC} Anthropic (Claude) ${DIM}— recommended${NC}"
    echo -e "  ${BOLD}2)${NC} OpenAI (GPT)"
    echo -e "  ${BOLD}3)${NC} Both"
    echo ""
    ask "Choose provider" "1"
    local provider_choice="$REPLY"

    local anthropic_key="" openai_key="" model=""

    case "$provider_choice" in
        1|"")
            echo ""
            ask_secret "Anthropic API key (sk-ant-...)"
            anthropic_key="$REPLY"
            if [[ -z "$anthropic_key" ]]; then
                error "API key is required. Get one at https://console.anthropic.com/"
                exit 1
            fi
            model="anthropic/claude-opus-4-6"
            ;;
        2)
            echo ""
            ask_secret "OpenAI API key (sk-...)"
            openai_key="$REPLY"
            if [[ -z "$openai_key" ]]; then
                error "API key is required. Get one at https://platform.openai.com/"
                exit 1
            fi
            model="openai/gpt-4o"
            ;;
        3)
            echo ""
            ask_secret "Anthropic API key (sk-ant-...)"
            anthropic_key="$REPLY"
            echo ""
            ask_secret "OpenAI API key (sk-...)"
            openai_key="$REPLY"
            if [[ -z "$anthropic_key" && -z "$openai_key" ]]; then
                error "At least one API key is required."
                exit 1
            fi
            model="anthropic/claude-sonnet-4-20250514"
            ;;
        *)
            error "Invalid choice"
            exit 1
            ;;
    esac

    echo ""
    ask "Model to use" "$model"
    model="$REPLY"
    success "LLM: $model"

    # ── Messaging Channels ────────────────────────────────────
    step "Messaging Channels"
    echo ""
    info "Connect messaging apps so you can talk to Moby anywhere."
    info "All channels are optional — skip any you don't need."
    dim "  (You can always add these later by editing .env)"
    echo ""

    local telegram_token="" discord_token="" slack_token="" whatsapp_auth=""

    if confirm "Set up Telegram?" "n"; then
        echo ""
        dim "  Create a bot via @BotFather on Telegram to get a token."
        dim "  Guide: https://core.telegram.org/bots#how-do-i-create-a-bot"
        echo ""
        ask_secret "Telegram bot token"
        telegram_token="$REPLY"
        [[ -n "$telegram_token" ]] && success "Telegram configured" || warn "Skipped"
    else
        dim "  Telegram skipped"
    fi
    echo ""

    if confirm "Set up Discord?" "n"; then
        echo ""
        dim "  Create a bot at https://discord.com/developers/applications"
        echo ""
        ask_secret "Discord bot token"
        discord_token="$REPLY"
        [[ -n "$discord_token" ]] && success "Discord configured" || warn "Skipped"
    else
        dim "  Discord skipped"
    fi
    echo ""

    if confirm "Set up Slack?" "n"; then
        echo ""
        dim "  Create a Slack app at https://api.slack.com/apps"
        echo ""
        ask_secret "Slack bot token (xoxb-...)"
        slack_token="$REPLY"
        [[ -n "$slack_token" ]] && success "Slack configured" || warn "Skipped"
    else
        dim "  Slack skipped"
    fi
    echo ""

    if confirm "Set up WhatsApp?" "n"; then
        echo ""
        dim "  WhatsApp requires the WhatsApp Business API or a session auth string."
        echo ""
        ask_secret "WhatsApp auth string"
        whatsapp_auth="$REPLY"
        [[ -n "$whatsapp_auth" ]] && success "WhatsApp configured" || warn "Skipped"
    else
        dim "  WhatsApp skipped"
    fi

    # ── Service Credentials ───────────────────────────────────
    step "Service Credentials"
    echo ""
    info "Give Moby access to your tools and services."
    info "All optional — skip any you don't need."
    dim "  (Credentials are stored in ~/.mobyclaw/credentials.env)"
    echo ""

    # Start with existing credentials or empty
    local cred_lines=()

    if confirm "Set up GitHub?" "n"; then
        echo ""
        dim "  GitHub uses OAuth device flow (no token needed)."
        dim "  After setup, run: mobyclaw run \"authenticate with GitHub\""
        dim "  Moby will walk you through \"gh auth login\" interactively."
        echo ""
        success "GitHub will be configured via 'gh auth login' after first start"
    else
        dim "  GitHub skipped"
    fi
    echo ""

    if confirm "Set up AWS?" "n"; then
        echo ""
        dim "  AWS credentials for the aws CLI."
        dim "  Create keys at: https://console.aws.amazon.com/iam/"
        echo ""
        ask_secret "AWS Access Key ID (AKIA...)"
        local aws_key_id="$REPLY"
        ask_secret "AWS Secret Access Key"
        local aws_secret="$REPLY"
        if [[ -n "$aws_key_id" && -n "$aws_secret" ]]; then
            cred_lines+=("AWS_ACCESS_KEY_ID=$aws_key_id")
            cred_lines+=("AWS_SECRET_ACCESS_KEY=$aws_secret")
            success "AWS configured"
        else
            warn "Skipped (both keys required)"
        fi
    else
        dim "  AWS skipped"
    fi
    echo ""

    # Custom credentials loop
    while confirm "Add a custom credential?" "n"; do
        echo ""
        ask "Variable name (e.g. NPM_TOKEN)"
        local cred_name="$REPLY"
        if [[ -n "$cred_name" ]]; then
            ask_secret "Value for $cred_name"
            if [[ -n "$REPLY" ]]; then
                cred_lines+=("${cred_name}=$REPLY")
                success "$cred_name configured"
            fi
        fi
        echo ""
    done

    dim "  Tip: edit ~/.mobyclaw/credentials.env anytime to add more."

    # ── Workspace Folders ─────────────────────────────────────
    step "Workspace Folders"
    echo ""
    info "Connect folders from your machine so Moby can read and"
    info "modify your files. Each folder appears at /workspace/<name>"
    info "inside the agent container."
    dim "  (All optional — you can add more later with: mobyclaw workspace add)"
    echo ""

    local workspace_lines=()

    while confirm "Add a workspace folder?" "n"; do
        echo ""
        ask "Path on your machine (e.g. ~/projects/myapp)"
        local ws_path="$REPLY"

        if [[ -z "$ws_path" ]]; then
            warn "No path given, skipping"
            echo ""
            continue
        fi

        # Expand and validate
        local abs_path
        abs_path=$(resolve_path "$ws_path")

        if [[ ! -d "$abs_path" ]]; then
            warn "Directory not found: $abs_path"
            if ! confirm "Add anyway?" "n"; then
                echo ""
                continue
            fi
        fi

        # Default name = basename
        local default_name
        default_name=$(basename "$abs_path")
        ask "Name in container" "$default_name"
        local ws_name="$REPLY"

        # Sanitize name: only alphanumeric, dash, underscore
        ws_name=$(echo "$ws_name" | tr -cd 'A-Za-z0-9_-')

        if [[ -z "$ws_name" ]]; then
            warn "Invalid name, skipping"
            echo ""
            continue
        fi

        workspace_lines+=("${ws_name}=${abs_path}")
        success "${ws_path} → /workspace/${ws_name}"
        echo ""
    done

    dim "  Tip: use 'mobyclaw workspace add <path>' to add more later."

    # ── Agent Settings ────────────────────────────────────────
    step "Agent Settings"
    echo ""

    ask "Heartbeat interval (how often Moby wakes up)" "30m"
    local heartbeat_interval="$REPLY"
    success "Heartbeat: every $heartbeat_interval"
    echo ""

    ask "Data directory" "$MOBYCLAW_HOME"
    MOBYCLAW_HOME="$REPLY"
    CREDENTIALS_FILE="$MOBYCLAW_HOME/credentials.env"
    WORKSPACES_FILE="$MOBYCLAW_HOME/workspaces.conf"
    success "Data directory: $MOBYCLAW_HOME"

    # ── Create data directory ─────────────────────────────────
    step "Setting up data directory"

    mkdir -p "$MOBYCLAW_HOME"/{memory,sessions,logs}
    success "Created $MOBYCLAW_HOME/"

    if [[ ! -f "$MOBYCLAW_HOME/soul.yaml" ]]; then
        cp "$SCRIPT_DIR/agents/moby/soul.yaml" "$MOBYCLAW_HOME/soul.yaml"
        success "Created soul.yaml (Moby's personality + config)"
    else
        dim "  soul.yaml already exists, keeping yours"
    fi

    if [[ ! -f "$MOBYCLAW_HOME/MEMORY.md" ]]; then
        cp "$SCRIPT_DIR/agents/moby/defaults/MEMORY.md" "$MOBYCLAW_HOME/MEMORY.md"
        success "Created MEMORY.md (long-term memory)"
    else
        dim "  MEMORY.md already exists, keeping yours"
    fi

    if [[ ! -f "$MOBYCLAW_HOME/HEARTBEAT.md" ]]; then
        cp "$SCRIPT_DIR/agents/moby/defaults/HEARTBEAT.md" "$MOBYCLAW_HOME/HEARTBEAT.md"
        success "Created HEARTBEAT.md (heartbeat checklist)"
    else
        dim "  HEARTBEAT.md already exists, keeping yours"
    fi

    # Write credentials.env
    if [[ ${#cred_lines[@]} -gt 0 ]] || [[ ! -f "$CREDENTIALS_FILE" ]]; then
        if [[ ! -f "$CREDENTIALS_FILE" ]] || [[ ${#cred_lines[@]} -gt 0 ]]; then
            # If file exists and we have new creds, append. If new file, create with header.
            if [[ ! -f "$CREDENTIALS_FILE" ]]; then
                cp "$SCRIPT_DIR/agents/moby/defaults/credentials.env" "$CREDENTIALS_FILE"
            fi
            for cred in "${cred_lines[@]}"; do
                echo "$cred" >> "$CREDENTIALS_FILE"
            done
            chmod 600 "$CREDENTIALS_FILE"
            success "Written credentials.env (${#cred_lines[@]} credentials)"
        fi
    else
        if [[ ! -f "$CREDENTIALS_FILE" ]]; then
            cp "$SCRIPT_DIR/agents/moby/defaults/credentials.env" "$CREDENTIALS_FILE"
            chmod 600 "$CREDENTIALS_FILE"
        fi
        dim "  credentials.env (no credentials added)"
    fi

    # Write workspaces.conf
    if [[ ${#workspace_lines[@]} -gt 0 ]] || [[ ! -f "$WORKSPACES_FILE" ]]; then
        if [[ ! -f "$WORKSPACES_FILE" ]]; then
            cp "$SCRIPT_DIR/agents/moby/defaults/workspaces.conf" "$WORKSPACES_FILE"
        fi
        for ws in "${workspace_lines[@]}"; do
            echo "$ws" >> "$WORKSPACES_FILE"
        done
        if [[ ${#workspace_lines[@]} -gt 0 ]]; then
            success "Written workspaces.conf (${#workspace_lines[@]} workspaces)"
        else
            dim "  workspaces.conf (no workspaces added)"
        fi
    else
        dim "  workspaces.conf already exists, keeping yours"
    fi

    # ── Write .env file ───────────────────────────────────────
    step "Writing configuration"

    cat > "$ENV_FILE" << ENVEOF
# ─── mobyclaw configuration ──────────────────────────────────
# Generated by: mobyclaw init
# Date: $(date -Iseconds)
#
# Edit this file to change your configuration.
# Restart with: mobyclaw down && mobyclaw up
# ─────────────────────────────────────────────────────────────

# ─── LLM Provider Keys ──────────────────────────────────────
ENVEOF

    [[ -n "$anthropic_key" ]] && echo "ANTHROPIC_API_KEY=$anthropic_key" >> "$ENV_FILE" || echo "# ANTHROPIC_API_KEY=" >> "$ENV_FILE"
    [[ -n "$openai_key" ]] && echo "OPENAI_API_KEY=$openai_key" >> "$ENV_FILE" || echo "# OPENAI_API_KEY=" >> "$ENV_FILE"

    cat >> "$ENV_FILE" << ENVEOF

# ─── Model ───────────────────────────────────────────────────
MOBYCLAW_MODEL=$model

# ─── Messaging Channels ─────────────────────────────────────
# Set a token to enable that channel. No token = adapter won't load.
ENVEOF

    [[ -n "$telegram_token" ]] && echo "TELEGRAM_BOT_TOKEN=$telegram_token" >> "$ENV_FILE" || echo "# TELEGRAM_BOT_TOKEN=" >> "$ENV_FILE"
    [[ -n "$discord_token" ]] && echo "DISCORD_BOT_TOKEN=$discord_token" >> "$ENV_FILE" || echo "# DISCORD_BOT_TOKEN=" >> "$ENV_FILE"
    [[ -n "$slack_token" ]] && echo "SLACK_BOT_TOKEN=$slack_token" >> "$ENV_FILE" || echo "# SLACK_BOT_TOKEN=" >> "$ENV_FILE"
    [[ -n "$whatsapp_auth" ]] && echo "WHATSAPP_AUTH=$whatsapp_auth" >> "$ENV_FILE" || echo "# WHATSAPP_AUTH=" >> "$ENV_FILE"

    cat >> "$ENV_FILE" << ENVEOF

# ─── Agent Settings ──────────────────────────────────────────
MOBYCLAW_HOME=$MOBYCLAW_HOME
MOBYCLAW_HEARTBEAT_INTERVAL=$heartbeat_interval
ENVEOF

    chmod 600 "$ENV_FILE"
    success "Written .env (permissions: 600)"

    # Generate the compose override
    generate_override
    if [[ -f "$OVERRIDE_FILE" ]]; then
        success "Generated docker-compose.override.yml"
    fi

    # ── Summary ───────────────────────────────────────────────
    step "Setup complete!"
    echo ""
    echo -e "  ${BOLD}Configuration:${NC}"
    echo -e "    Model:        ${CYAN}$model${NC}"

    local channels=""
    [[ -n "$telegram_token" ]] && channels+="Telegram "
    [[ -n "$discord_token" ]] && channels+="Discord "
    [[ -n "$slack_token" ]] && channels+="Slack "
    [[ -n "$whatsapp_auth" ]] && channels+="WhatsApp "
    if [[ -n "$channels" ]]; then
        echo -e "    Channels:     ${CYAN}$channels${NC}"
    else
        echo -e "    Channels:     ${DIM}none (CLI only)${NC}"
    fi

    if [[ ${#cred_lines[@]} -gt 0 ]]; then
        local cred_names=""
        for cred in "${cred_lines[@]}"; do
            cred_names+="$(echo "$cred" | cut -d= -f1) "
        done
        echo -e "    Credentials:  ${CYAN}$cred_names${NC}"
    else
        echo -e "    Credentials:  ${DIM}none${NC}"
    fi

    if [[ ${#workspace_lines[@]} -gt 0 ]]; then
        echo -e "    Workspaces:   ${CYAN}${#workspace_lines[@]} folder(s)${NC}"
        for ws in "${workspace_lines[@]}"; do
            local ws_name ws_path
            ws_name=$(echo "$ws" | cut -d= -f1)
            ws_path=$(echo "$ws" | cut -d= -f2-)
            echo -e "                  ${DIM}${ws_path} → /workspace/${ws_name}${NC}"
        done
    else
        echo -e "    Workspaces:   ${DIM}none${NC}"
    fi

    echo -e "    Heartbeat:    ${CYAN}every $heartbeat_interval${NC}"
    echo -e "    Data dir:     ${CYAN}$MOBYCLAW_HOME${NC}"
    echo ""
    echo -e "  ${BOLD}Files created:${NC}"
    echo -e "    ${DIM}$MOBYCLAW_HOME/soul.yaml${NC}         — Moby's personality"
    echo -e "    ${DIM}$MOBYCLAW_HOME/MEMORY.md${NC}         — Long-term memory"
    echo -e "    ${DIM}$MOBYCLAW_HOME/HEARTBEAT.md${NC}      — Heartbeat checklist"
    echo -e "    ${DIM}$MOBYCLAW_HOME/credentials.env${NC}   — Service credentials"
    echo -e "    ${DIM}$MOBYCLAW_HOME/workspaces.conf${NC}   — Workspace folders"
    echo -e "    ${DIM}$ENV_FILE${NC}                  — Secrets & config"
    echo ""

    if [[ "$called_from_up" != "true" ]]; then
        echo -e "  ${BOLD}Next steps:${NC}"
        echo -e "    ${GREEN}mobyclaw up${NC}              — Start Moby"
        echo -e "    ${GREEN}mobyclaw run \"Hello!\"${NC}    — Send a message"
        echo -e "    ${GREEN}mobyclaw chat${NC}            — Interactive chat"
        echo ""
        dim "  Tip: edit ~/.mobyclaw/soul.yaml to customize Moby's personality."
        echo ""
    fi
}

cmd_up() {
    if [[ ! -f "$ENV_FILE" ]]; then
        info "First time? Let's set things up.\n"
        cmd_init true
        echo ""
    fi

    load_env_home

    step "Starting Moby"

    # Regenerate override from current config
    generate_override
    if [[ -f "$OVERRIDE_FILE" ]]; then
        dim "  Generated docker-compose.override.yml (credentials + workspaces)"
    fi

    info "Building and launching containers..."
    dc up -d --build

    # Start the restart watcher (background process on host)
    start_watcher

    echo ""
    success "Moby is running!"
    if is_watcher_running; then
        dim "  Restart watcher active (self-modification enabled)"
    fi
    echo ""
    echo -e "  ${BOLD}What now:${NC}"
    echo -e "    ${GREEN}mobyclaw run \"Hello!\"${NC}   — Send a message"
    echo -e "    ${GREEN}mobyclaw chat${NC}            — Interactive chat"
    echo -e "    ${GREEN}mobyclaw logs${NC}            — View logs"
    echo -e "    ${GREEN}mobyclaw status${NC}          — Check health"
    echo ""
}

cmd_down() {
    info "Stopping mobyclaw..."
    stop_watcher
    dc down
    success "Stopped."
}

cmd_logs() {
    local service="${1:-}"
    if [[ -n "$service" ]]; then
        dc logs -f "$service"
    else
        dc logs -f
    fi
}

cmd_status() {
    echo ""
    echo -e "${BOLD}mobyclaw status${NC}"
    echo ""
    dc ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
    echo ""

    if curl -sf http://localhost:3000/health &>/dev/null 2>&1; then
        success "Gateway: healthy"
        local status
        status=$(curl -s http://localhost:3000/status 2>/dev/null)
        if [[ -n "$status" ]]; then
            local channels
            channels=$(echo "$status" | jq -r '.channels | join(", ")' 2>/dev/null)
            local sess
            sess=$(echo "$status" | jq -r '.sessions' 2>/dev/null)
            [[ -n "$channels" && "$channels" != "" ]] && info "Channels: $channels"
            [[ -n "$sess" ]] && info "Active sessions: $sess"
        fi
    else
        warn "Gateway: not responding (may still be starting)"
    fi

    # Show watcher status
    if is_watcher_running; then
        success "Restart watcher: active"
    else
        warn "Restart watcher: not running (self-modification disabled)"
    fi

    # Show workspaces
    load_env_home
    if [[ -f "$WORKSPACES_FILE" ]]; then
        local ws_count=0
        while IFS='=' read -r name path; do
            [[ -z "$name" || "$name" == \#* ]] && continue
            name=$(echo "$name" | xargs)
            path=$(echo "$path" | xargs)
            [[ -z "$name" || -z "$path" ]] && continue
            ws_count=$((ws_count + 1))
        done < "$WORKSPACES_FILE"
        if [[ $ws_count -gt 0 ]]; then
            info "Workspaces: $ws_count folder(s) mounted"
        fi
    fi

    echo ""
}

cmd_run() {
    local prompt="$*"
    if [[ -z "$prompt" ]]; then
        error "Usage: mobyclaw run \"your prompt here\""
        exit 1
    fi

    if ! curl -sf http://localhost:3000/health &>/dev/null 2>&1; then
        error "Moby is not running. Start with: ${BOLD}mobyclaw up${NC}"
        exit 1
    fi

    stream_prompt "$prompt"
}

cmd_chat() {
    if ! curl -sf http://localhost:3000/health &>/dev/null 2>&1; then
        error "Moby is not running. Start with: ${BOLD}mobyclaw up${NC}"
        exit 1
    fi

    banner
    info "Chatting with Moby. Type ${BOLD}exit${NC} or ${BOLD}Ctrl+C${NC} to quit."
    echo ""

    local session_id="cli-$(date +%s)"

    while true; do
        echo -en "${BOLD}you:${NC} "
        read -r prompt || break
        [[ "$prompt" == "exit" || "$prompt" == "quit" ]] && break
        [[ -z "$prompt" ]] && continue

        echo -en "${CYAN}${BOLD}moby:${NC} "
        stream_prompt "$prompt" "$session_id"
        echo ""
    done

    echo ""
    info "Goodbye!"
}

cmd_exec() {
    dc exec moby /bin/bash
}

# ─── Workspace subcommands ────────────────────────────────────

cmd_workspace() {
    local subcmd="${1:-list}"
    shift || true

    load_env_home

    case "$subcmd" in
        list)   workspace_list ;;
        add)    workspace_add "$@" ;;
        remove) workspace_remove "$@" ;;
        *)
            error "Unknown workspace command: $subcmd"
            echo ""
            echo -e "${BOLD}Usage:${NC}"
            echo -e "  mobyclaw workspace list              — Show mounted workspaces"
            echo -e "  mobyclaw workspace add <path> [name] — Add a workspace folder"
            echo -e "  mobyclaw workspace remove <name>     — Remove a workspace"
            exit 1
            ;;
    esac
}

workspace_list() {
    echo ""
    echo -e "${BOLD}Workspace folders${NC}"
    echo ""

    if [[ ! -f "$WORKSPACES_FILE" ]]; then
        dim "  No workspaces configured."
        dim "  Add one with: mobyclaw workspace add ~/projects/myapp"
        echo ""
        return 0
    fi

    local count=0
    while IFS='=' read -r name path; do
        [[ -z "$name" || "$name" == \#* ]] && continue
        name=$(echo "$name" | xargs)
        path=$(echo "$path" | xargs)
        [[ -z "$name" || -z "$path" ]] && continue

        local status_icon="✓"
        local status_color="$GREEN"
        if [[ ! -d "$path" ]]; then
            status_icon="✗"
            status_color="$RED"
        fi

        echo -e "  ${status_color}${status_icon}${NC} ${BOLD}${name}${NC}"
        echo -e "    ${DIM}${path} → /workspace/${name}${NC}"
        count=$((count + 1))
    done < "$WORKSPACES_FILE"

    if [[ $count -eq 0 ]]; then
        dim "  No workspaces configured."
        dim "  Add one with: mobyclaw workspace add ~/projects/myapp"
    else
        echo ""
        dim "  $count workspace(s). Changes take effect after: mobyclaw down && mobyclaw up"
    fi
    echo ""
}

workspace_add() {
    local ws_path="${1:-}"
    local ws_name="${2:-}"

    if [[ -z "$ws_path" ]]; then
        error "Usage: mobyclaw workspace add <path> [name]"
        echo ""
        echo -e "  ${BOLD}Examples:${NC}"
        echo -e "    mobyclaw workspace add ~/projects/myapp"
        echo -e "    mobyclaw workspace add ~/Documents/notes docs"
        exit 1
    fi

    # Resolve path
    local abs_path
    abs_path=$(resolve_path "$ws_path")

    if [[ ! -d "$abs_path" ]]; then
        warn "Directory not found: $abs_path"
        if ! confirm "Add anyway?" "n"; then
            exit 1
        fi
    fi

    # Default name = basename
    if [[ -z "$ws_name" ]]; then
        ws_name=$(basename "$abs_path")
    fi

    # Sanitize name
    ws_name=$(echo "$ws_name" | tr -cd 'A-Za-z0-9_-')

    if [[ -z "$ws_name" ]]; then
        error "Invalid workspace name"
        exit 1
    fi

    # Check for duplicate name
    if [[ -f "$WORKSPACES_FILE" ]]; then
        if grep -qE "^${ws_name}=" "$WORKSPACES_FILE" 2>/dev/null; then
            error "Workspace '${ws_name}' already exists. Remove it first:"
            echo -e "  mobyclaw workspace remove ${ws_name}"
            exit 1
        fi
    fi

    # Create workspaces.conf if needed
    if [[ ! -f "$WORKSPACES_FILE" ]]; then
        mkdir -p "$MOBYCLAW_HOME"
        cp "$SCRIPT_DIR/agents/moby/defaults/workspaces.conf" "$WORKSPACES_FILE"
    fi

    # Append
    echo "${ws_name}=${abs_path}" >> "$WORKSPACES_FILE"
    success "Added workspace: ${abs_path} → /workspace/${ws_name}"
    echo ""
    warn "Restart for changes to take effect: ${BOLD}mobyclaw down && mobyclaw up${NC}"
    echo ""
}

workspace_remove() {
    local ws_name="${1:-}"

    if [[ -z "$ws_name" ]]; then
        error "Usage: mobyclaw workspace remove <name>"
        exit 1
    fi

    if [[ ! -f "$WORKSPACES_FILE" ]]; then
        error "No workspaces configured."
        exit 1
    fi

    if ! grep -qE "^${ws_name}=" "$WORKSPACES_FILE" 2>/dev/null; then
        error "Workspace '${ws_name}' not found."
        echo ""
        echo "Available workspaces:"
        workspace_list
        exit 1
    fi

    # Remove the line (macOS-compatible sed)
    if [[ "$(uname)" == "Darwin" ]]; then
        sed -i '' "/^${ws_name}=/d" "$WORKSPACES_FILE"
    else
        sed -i "/^${ws_name}=/d" "$WORKSPACES_FILE"
    fi

    success "Removed workspace: ${ws_name}"
    echo ""
    warn "Restart for changes to take effect: ${BOLD}mobyclaw down && mobyclaw up${NC}"
    echo ""
}

# ─── Schedules command ─────────────────────────────────

cmd_schedules() {
    if ! curl -sf http://localhost:3000/health &>/dev/null 2>&1; then
        error "Moby is not running. Start with: ${BOLD}mobyclaw up${NC}"
        exit 1
    fi

    echo ""
    echo -e "${BOLD}Scheduled reminders${NC}"
    echo ""

    local schedules
    schedules=$(curl -s "http://localhost:3000/api/schedules?status=pending" 2>/dev/null)

    local count
    count=$(echo "$schedules" | jq 'length' 2>/dev/null || echo "0")

    if [[ "$count" == "0" ]]; then
        dim "  No pending schedules."
        dim "  Ask Moby to set a reminder: mobyclaw run \"Remind me tomorrow at 9am to...\""
        echo ""
        return 0
    fi

    echo "$schedules" | jq -r '.[] | "  \(.due)  \(.channel)\n    \(.message)\n    id: \(.id)  repeat: \(.repeat // "one-shot")\n"' 2>/dev/null

    dim "  $count pending schedule(s)"
    echo ""
}

# ─── Help & version ──────────────────────────────────────────

cmd_help() {
    banner
    echo -e "${BOLD}Usage:${NC} mobyclaw <command> [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo -e "  ${GREEN}init${NC}                          Interactive setup"
    echo -e "  ${GREEN}up${NC}                            Start Moby (runs init if needed)"
    echo -e "  ${GREEN}down${NC}                          Stop everything"
    echo -e "  ${GREEN}logs${NC} [service]                Tail container logs"
    echo -e "  ${GREEN}status${NC}                        Show health and services"
    echo -e "  ${GREEN}run${NC} \"<prompt>\"                Send a one-shot prompt"
    echo -e "  ${GREEN}chat${NC}                          Interactive chat session"
    echo -e "  ${GREEN}exec${NC}                          Shell into the agent container"
    echo -e "  ${GREEN}workspace list${NC}                Show mounted workspaces"
    echo -e "  ${GREEN}workspace add${NC} <path> [name]   Mount a host folder"
    echo -e "  ${GREEN}workspace remove${NC} <name>       Unmount a folder"
    echo -e "  ${GREEN}schedules${NC}                     Show upcoming schedules"
    echo -e "  ${GREEN}help${NC}                          Show this help"
    echo -e "  ${GREEN}version${NC}                       Show version"
    echo ""
    echo -e "${BOLD}Getting started:${NC}"
    echo -e "  ${DIM}$ mobyclaw up${NC}                          # Set up + start"
    echo -e "  ${DIM}$ mobyclaw run \"Hello Moby!\"${NC}           # Talk to it"
    echo -e "  ${DIM}$ mobyclaw workspace add ~/projects/app${NC} # Mount a folder"
    echo ""
    echo -e "${BOLD}Configuration:${NC}"
    echo -e "  ${DIM}~/.mobyclaw/soul.yaml${NC}          Moby's personality"
    echo -e "  ${DIM}~/.mobyclaw/MEMORY.md${NC}          Long-term memory"
    echo -e "  ${DIM}~/.mobyclaw/credentials.env${NC}    Service credentials (gh, aws, ...)"
    echo -e "  ${DIM}~/.mobyclaw/workspaces.conf${NC}    Mounted host folders"
    echo -e "  ${DIM}.env${NC}                           API keys and settings"
    echo ""
}

cmd_version() {
    echo "mobyclaw $VERSION"
}

# ─── Main ─────────────────────────────────────────────────────

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        init)      cmd_init "$@" ;;
        up)        cmd_up "$@" ;;
        down)      cmd_down "$@" ;;
        logs)      cmd_logs "$@" ;;
        status)    cmd_status "$@" ;;
        run)       cmd_run "$@" ;;
        chat)      cmd_chat "$@" ;;
        exec)      cmd_exec "$@" ;;
        workspace) cmd_workspace "$@" ;;
        schedules) cmd_schedules "$@" ;;
        help|-h|--help)       cmd_help "$@" ;;
        version|-v|--version) cmd_version "$@" ;;
        *)
            error "Unknown command: $cmd"
            cmd_help
            exit 1
            ;;
    esac
}

main "$@"
